<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>TinyBus</title>
	<link media="print" />
	<link rel="stylesheet" href="https://www.christian-marty.ch/WebPaperLayout/documentTemplate_A4.css">
	<link rel="stylesheet" href="https://www.christian-marty.ch/WebPaperLayout/pageLayout.css">
    <link rel="stylesheet" href="https://www.christian-marty.ch/WebPaperLayout/navigation.css">
    <link rel="stylesheet" href="global.css">
</head>

<script src="https://www.christian-marty.ch/WebPaperLayout/page.js"></script>
<script src="https://www.christian-marty.ch/WebPaperLayout/navigation.js"></script>

<body>

<div class="wpl_navigation">
</div>

<div class="main">

<document-page 
    title="TinyBus" 
    subtitle="Interface and protocol documentation" 
    footer="christian-marty.ch/tinybus/documentation/index.html"
    link="https://www.christian-marty.ch/tinybus/documentation/index.html"
>
    <h1>TinyBus</h1>
    <p>The TinyBus is a galvanically isolated, half-duplex, request-response, master-slave, low-speed bus.</p>
    <p>It was primarily developed to enable easy and cheap, but reliable communication with small microcontrollers.</p>
            
    <h2>Key Features</h2>
    <ul>
        <li>Half-duplex, bi-directional</li>
        <li>Galvanic isolation</li>
        <li>Polarity agnostic</li>
        <li>Hot plug capable</li>
        <li>Star, tree or bus topology</li>
        <li>Up to 14 devices per line</li>
        <li>Automatic baud rate detection</li>
    </ul>

    <h2>Motivation</h2>
    <p>TinyBus was developed to enable cheap and easy, galvanically isolated communication without a strict network topology.</p>

    <h2>Inspiration</h2>
    <p>TinyBus was partially inspired by the "Digital Addressable Lighting Interface" (DALI) and "Musical Instrument Digital Interface" (MIDI).
        However, neither the hardware nor software layer of TinyBus is compatible with DALI or MIDI.</p>

    <p>The name TinyBus was chosen because it is a bus and was developed for <s>Atmel</s> Microchip AVR ATtiny microcontrollers.</p>
</document-page>

<document-page>
    <h2>Terminology</h2>
    <table>
        <tr>
            <th>TinyBus</th>
            <td>This whole project including the hardware and software layer.</td>
        </tr>
        <tr>
            <th>TinyLoader</th>
            <td>The software part of this project</td>
        </tr>
        <tr>
            <th>Kernel</th>
            <td>Part of the firmware that boots the system, handles communication and runs the application.</td>
        </tr>

        <tr>
            <th>Application</th>
            <td>The user application.</td>
        </tr>
    
        <tr>
            <th>Master</th>
            <td>Dominant / authoritative entity on the bus.</td>
        </tr>

        <tr>
            <th>Slave</th>
            <td>Submissive entity on the bus.</td>
        </tr>

        <tr>
            <th>Node</th>
            <td>One entity on the bus.</td>
        </tr>
        <tr>
            <th>Frame </th>
            <td>Unit of data on the data link layer.</td>
        </tr>
        <tr>
            <th>Packet</th>
            <td>Unit of data on the network layer.</td>
        </tr>
        <tr>
            <th>Message</th>
            <td>Unit of data on the application layer.</td>
        </tr>
    </table>
    <h3>Requirement Levels</h3>
    <p>Requirement levels are denoted in accordance with RFC2119.</p>
    <h3>Numbering Format</h3>
    <p>Numbers are represented in decimal format. A complementary representation in an hexadecimal or binary form can be added next to the decimal representation. e.g. 85 (55h / 01010101b).</p>
</document-page>

<document-page>
    <h2>Topology</h2>
    <p>The TinyBus is a strictly master-slave, request-response based protocol.</p>
    <p>Each bus consists of one bus power supply, one master node, and up to 14 slave nodes.</p>
    <img src="system.png" style="display:block; margin: auto; width: 60%;">



    <h3>Addressing</h3>
    <p>The TinyBus supports up to 14 individually addressable devices plus one master-node.</p>
    <p>Additionally, all nodes can be commanded simultaneously via a broadcast address.</p>
    
    <h3>Baud Rates</h3>
    <p>Each TinyBus node must support all eight specified baud rates.</p>

    <h4>Limitations</h4>
    <p>Empirical testing has shown that the highest realistically achievable standard baud rate is 14'400 baud. This was tested over multiple meters of cabling in a tree topology.</p>
    
    <h3>Idle state, power conservation and node wake-up</h3>
    <p>In idle state, the bus is logical high. This allows a node to detect if it is currently connected to an active bus.</p>
    <p>If a node is disconnected or the bus becomes inactive, the node can enter standby or power down.</p>
    <h4>Wake-Up Signal</h4>
    <p>The "RX_RAW" signal (see Interface) can be used as wake-up signal.</p> 
    <p>The output of the optocoupler being open-collector and not reliant on any auxiliary voltage supply allows for a true zero standby power consumption design.</p>

    <h3>Electrical Characteristics and the Bus Power Supply</h3>
    <p>TinyBus is based on a current loop.</p>
    <p>The loop current must be limited to approximately 80 mA. The open loop voltage must be limited to approximately 12V DC.</p>

    
    
</document-page>

<document-page>
    <h3>Interface</h3>
    <img src="interface.png" width="100%">
    <p>The above diagram shows the reference implementation of the interface of a TinyBus node.</p>
    <h4>Schematic Explanation</h4>
    <p><b>Note:</b> Some of the components serve multiple purposes and are therefore reverenced multiple times.</p>
    <h5>R1, R2, D1, C1 - Protection and filtering</h5>
    <p>D1 is a transient surge arrestor. It will clamp short voltage spikes above approximatly 25V and thereby protects the following circuit.</p>
    <p>R1, R2 and C1 form a low pass filter. It dampens the high-frequency content of the signal, thereby reducing conducted electromagnetic interference (EMI).</p>
    <h5>D2, D3 - Full Bridge Rectifier</h5>
    <p>D2 and D3 form a full bridge rectifier.  This enables the polarity agnosticity of the TinyBus interface.</p>
    <h5>T1, R1,R2, R4, R5, IC2 - Transmitter</h5>
    <p>T1 in combination with IC2 forms the transmitter part of the interface.</p>
    <p>R1 and R2 limit the maximum sink current of the transmitter.</p>
    <h5>R3, D2, D3, D4, IC1 - Receiver</h5>
    <p>D2, D3, D4 and the LED of IC1 have a combined forward voltage of approximately 7V. This value represents the threshold between a logical high and a low. R3 limits the forward current of IC1s LED to about 6mA.</p>
</document-page>

<document-page>
    <h3>Connectors and Pinout</h3>
    <p>TinyBus devices should use a 4P4C or 4P2C modular connector (commonly, but incorrectly, often referred to as RJ-10 connector).</p>
    <p>For a bus-powered device the 4P4C modular connector must be used. For a not bus-powered device the 4P2C modular connector should be used.</p>
    <p>This allows for easy identification of bus-powered and not bus-power devices by examining the connector.</p>
    <h4>Bus Power</h4>
    <p>Voltage: TBD</p>
    <p>Max Current: TBD</p>
    <h4>Pinout</h4>
    <p>In case the 4P4C or 4P2C modular connector is used, the follwing pinout must be followed:</p>
    <img src="connector.png" width="20%">
    <table>
        <tr>
            <th>Pin</th>
            <th>Signal</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>1</td>
            <td>V- / GND</td>
            <td>Optional, for bus powerd devices</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Bus -</td>
            <td></td>
        </tr>
        <tr>
            <td>3</td>
            <td>Bus +</td>
            <td></td>
        </tr>
        <tr>
            <td>4</td>
            <td>V+</td>
            <td>Optional, for bus powered devices</td>
        </tr>
    </table>
    <h3>Cabling Requirements</h3>
    <h4>Maximum Cable Length</h4>
    <p>TinyBus does not directly specifie a maximum cable length. The maximum cable length primarily depends on the cable's loop resistance.</p>
    <p>Due to the current-loop-like operation of TinyBus, the resistance of the cable must not exceed a value causing a voltage drop of approximately 7V.</p>
    <p>Considering the typical 100mA bus current and the 10 Ohms input resistance of a node, a loop resistance of approximately 60 Ohms must not be exceeded.</p>

</document-page>

<document-page>
    <h2>Data Link Layer</h2>

    <h3>Framing</h3>
    <p>Both, the request and response, use the same frame format.</p>
    <p>The framing is based on a modified version of the "Consistent Overhead Byte Stuffing" (COBS) algorithm. 
        To enable auto baudrate detection, instead of 0 (0h), 85 (55h / 01010101b) is used as delimiter.</p>
    <p>Each frame starts and ends with the delimiter byte.</p>
    <p>Per packet, a maximum payload size of 20 bytes shall not be exceeded. Therefore, the maximum total frame lenght is 26 bytes.</p>

    <table style="border: none;">
        <tr>
            <td class="annotation_data" colspan="7">Data Link Layer (Frame)</td>
        </tr>
        <tr>
            <td  colspan="7" ></td>
        </tr>
        <tr>
            <td class="dataframe_frame">Start Byte</br>(0x55)</td>
            <td class="dataframe_frame">Overhead Byte</td>
            <td class="dataframe_data">Instruction Byte</td>
            <td class="dataframe_data">Payload</td>
            <td class="dataframe_frame">CRC16</br>(High Byte)</td>
            <td class="dataframe_frame">CRC16</br>(Low Byte)</td>
            <td class="dataframe_frame">End Byte</br>(0x55)</td>
        </tr>
        <tr>
            <td style="border: none;" colspan="2" ></td>
            <td colspan="2" ></td>
        </tr>
        <tr>
            <td colspan="2" style="border: none;"></td>
            <td class="annotation_data" colspan="2">Network Layer (Packet)</td>
        </tr>
    </table>

    <h4>Acknowledgment</h4>
    <p>Each valid frame sent to an individual device must be acknowledged by that device. Broadcast frames shall not be acknowledged.</p>
    <p>The acknowledgment frame is constructed the same way as a regular data frame. The instruction byte shall be the same as it was in the request. If there is no data to be returned, the payload shall be left empty.</p>
    
    <h4>Non-Acknowledgment</h4>
    <p>A non-acknowledgment should be returned if an error on a higher layer (Network Layer or  Application Layer) is detected.</p>
    <p>Incorrect frames on the data link layer must not trigger a non-acknowledgment. Instead, the incorrect frame shall be ignored.</p>
    <p>A non-acknowledgment uses the same frame format as an acknowledgment with the exception that no payload shall be returned and the CRC shall be set to 0.</p>
    
    <h3>CRC</h3>
    <p>The CRC16 uses an x16 + x12 + x5 + 1 polynomial (0x1021) initialized to 0xFFFF.</p>

    <p>The CRC calculation includes the data contained in a network layer packet, namely the instruction byte and the payload bytes. 
        The start-byte and stop-byte as well as the overhead-byte are not included in the CRC calculation.</p>

</document-page>

<document-page>
    <h2>Network Layer</h2>
    <p>Each packet contains an instruction and a payload.</p>

    <table style="border: none;">
        <tr>
            <td class="annotation_data" colspan="2">Network Layer (Packet)</td>
        </tr>
        <tr>
            <td colspan="2" ></td>
        </tr>
        <tr>
            <td class="dataframe_frame" width="25%">Instruction Byte</td>
            <td class="dataframe_data">Payload</td>
        </tr>
        <tr>
            <td style="border: none;"></td>
            <td colspan="1" ></td>
        </tr>
        <tr >
            <td style="border: none;" ></td>
            <td class="annotation_data" colspan="1">Application Layer (Message)</td>
        </tr>
    </table>

    <h3>Instruction Byte</h3>
    <table>
        <tr>
            <th colspan="8">Instruction Byte</th>
        </tr>
        <tr>
            <td colspan="4">Address (Upper Nibble)</td>
            <td colspan="4">Command (Lower Nibble)</td>
        </tr>
    </table>
    <p>The instruction byte is split into two parts: the address (upper nibble) and the command (lower nibble).</p>

    <h4>Addressing</h4>
    <p>The 4-bit address range allows for addresses between 0 (0h) and 15 (Fh).</p>
    <ul>
        <li>15 (Fh) is reserved as a broadcast address and cannot be used as an individual device address.</li>
        <li>0 (0h) is the default address of an unconfigured device and should not be used in an installation.</li>
    </ul>
    <p>The remaining address range of 1 (1h) to 14 (Eh) can be assigned freely.</p>

    <h4>Commands</h4>

    <p>The command ids 0-14 (0h-Eh) are application specific. For details on those commands see the respective application documentation.</p>
    <p>The command 15 (Fh) is reserved for kernel communication.</p>

    <table>
        <tr>
            <th>Command Id</th>
            <th>Command</th>
            <th>Payload</th>
            <th>Reply (1)</th>
        </tr>
        <tr>
            <td>0-14</td>
            <td>Application Specific</td>
            <td>Application Specific</td>
            <td>Application Specific</td>
        </tr>
        <tr>
            <td>15</td>
            <td>Kernel Commands</td>
            <td>Subcommand Specific</td>
            <td>Subcommand Specific</td>
        </tr>
    </table>
    <p>1) Only if individual addressed, broadcast messages get no reply.</p>

    <h3>Visual Indicators</h3>
    <p>Visual indicators can be used to indicate network activity.</p>
    <p>The receive-indicator shall light up when a valid message with a matching address is received.</p>
    <p>The transmit-indicator shall light up when a message starts being transmitted.</p>

    <h4>Colours</h4>
    <p>The indicator light for receiving shall be green while the indicator light for transmitting shall be red.</p>
    

</document-page>

<document-page>
    <h2>Application Layer</h2>

    <img src="architecture.png" width="100%">

    <h4>Starting the application</h4>
    <p>The application will only start if the application CRC is valid.</p> 
    
    <h5>Application Autostart Disabled</h5>
    <p>The device will not run the application until either the "Start App" kernel command or a command other than a kernel command (Command Id 15) is received. 
        Any application command (Command Id 0-14) will start the application.</p>
    
    <h5>Application Autostart Enabled</h5>
    <p>The device will run the application automatically as soon as the device is powerd-on.</p>
    <p>In case a device reset is triggered due to a watchdog timeout, division-by-zero error, or similar the application should not autostart.</p>

    <h4>Stopping the application</h4>
    <p>To stop the execution of the application the "Stop App" kernel command can be sent.</p>
</document-page>

<document-page>
    <h3>Application Header</h3>

    <table style="table-layout : fixed; border: none;">
        <tr>
            <td style="border: none;"></td>
            <th style="width: 4%;">Bit</th>
            <th>7</th>
            <th>6</th>
            <th>5</th>
            <th>4</th>
            <th>3</th>
            <th>2</th>
            <th>1</th>
            <th>0</th>
        </tr>
        <tr>
            <th>Byte</th>
        </tr>
        <tr>
            <th>0</th>
            <td style="border: none;"></td>
            <td>Autostart</td>
            <td colspan="5">Reserved</td>
            <td colspan="2">Header Version</td>
        </tr>
        <tr>
            <th>1</th>
            <td style="border: none;"></td>
            <td colspan="8">Reserved</td>
        </tr>
        <tr>
            <th>2</th>
            <td style="border: none;"></td>
            <td colspan="8">Major Firmware Version</td>
        </tr>
        <tr>
            <th>3</th>
            <td style="border: none;"></td>
            <td colspan="8">Minor Firmware Version</td>
        </tr>
        <tr>
            <th>4</th>
            <td style="border: none;"></td>
            <td colspan="8">Hardware Id (High)</td>
        </tr>
        <tr>
            <th>5</th>
            <td style="border: none;"></td>
            <td colspan="8">Hardware Id (Low)</td>
        </tr>
        <tr>
            <th>6</th>
            <td style="border: none;"></td>
            <td colspan="8">Major Hardware Version</td>
        </tr>
        <tr>
            <th>7</th>
            <td style="border: none;"></td>
            <td colspan="8">Minor Hardware Version</td>
        </tr>
        <tr>
            <th>8-13</th>
            <td style="border: none;"></td>
            <td colspan="8">Reserved</td>
        </tr>
        <tr>
            <th>14-31</th>
            <td style="border: none;"></td>
            <td colspan="8">Application Name</td>
        </tr>
    </table>

    <p></p>
    <h4>Autostart</h4>
    <p>If this bit is set, the application starts automatically on power-up</p>

    <h4>Minor Version</h4>
    <p></p>

    <h4>Major Version</h4>
    <p></p>

    <h4>Application Name</h4>
    <p></p>

</document-page>


<document-page>

    <h3>Kernel Communication</h3>
    <p>Each kernel command message is composed of a subcommand id and a payload.</p>
    <table>
        <tr>
            <td class="annotation_data" colspan="2">Application Layer (Message)</td>
        </tr>
        <tr>
            <td colspan="2" ></td>
        </tr>
        <tr>
            <td class="dataframe_frame" width="25%">Kernel Subcommand Id</td>
            <td class="dataframe_data">Payload</td>
        </tr>
    </table>

    <p><b>Note:</b> In the response the most signifcant bit of the sub command id is set.</p>

    <h4>Subcommands</h4>
    <table>
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Payload</th>
            <th>Reply</th>
        </tr>
        <tr>
            <td>0</td>
            <td>Get Device State</td>
            <td>Empty</td>
            <td>Device State</td>
        </tr>
        <tr>
            <td>1</td>
            <td>Get Hardware Information</td>
            <td>Empty</td>
            <td>Hardware Information</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Get Memory Information</td>
            <td>Empty</td>
            <td>Memory Information</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Get App CRC</td>
            <td>Empty</td>
            <td>CRC of app sector</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Erase App Section</td>
            <td>Empty</td>
            <td>Acknowledgment</td>
        </tr>
        <tr>
            <td>5</td>
            <td>Write Page</td>
            <td>Write Address + Data</td>
            <td>Acknowledgment</td>
        </tr>
        <tr>
            <td>6</td>
            <td>Write EEPROM</td>
            <td>Page Address + Page Data</td>
            <td>Acknowledgment</td>
        </tr>
        <tr>
            <td>7</td>
            <td>Read EEPROM</td>
            <td>Byte Address + Read Size</td>
            <td>EEPROM Data</td>
        </tr>
        <tr>
            <td>8</td>
            <td>Read RAM</td>
            <td>Byte Address + Read Size</td>
            <td>RAM Data</td>
        </tr>
        <tr>
            <td colspan="4" ></td>
        </tr>
        <tr>
            <td>10</td>
            <td>Reboot</td>
            <td>Empty</td>
            <td>None</td>
        </tr>
        <tr>
            <td>11</td>
            <td>Start App</td>
            <td>Empty</td>
            <td>Acknowledgment</td>
        </tr>
        <tr>
            <td>12</td>
            <td>Stop App</td>
            <td>Empty</td>
            <td>Acknowledgment</td>
        </tr>
        <tr>
            <td>13</td>
            <td>Get Application Name</td>
            <td>Empty</td>
            <td>Application Name</td>
        </tr>
        <tr>
            <td>14</td>
            <td>Get Application Version</td>
            <td>Empty</td>
            <td>Application Version</td>
        </tr>
        <tr>
            <td>15</td>
            <td>Set Address</td>
            <td>New Address</td>
            <td>Acknowledgment</td>
        </tr>
        <tr>
            <td colspan="4" ></td>
        </tr>
        <tr>
            <td>32</td>
            <td>Set Baud Rate</td>
            <td>New Baud Rate</td>
            <td>Acknowledgment</td>
        </tr>
        <tr>
            <td>33</td>
            <td>Save Baud Rate</td>
            <td>Empty</td>
            <td>Acknowledgment</td>
        </tr>
    </table>
</document-page>

<document-page>
    <h3>Command 0x00 - <span>Get Device State</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Device State / non-acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command will return a device state message.</p>

    <h4>Device State Message</h4>

    <table>
        <tr>
            <th>Index</th>
            <th>Data</th>
            <th>Size in Bytes</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>0:7-4</td>
            <td>Device Address</td>
            <td>0.5</td>
            <td>The address of the device</td>
        </tr>
        <tr>
            <td>0:3-0</td>
            <td>Device State</td>
            <td>0.5</td>
            <td>The state of the device</td>
        </tr>
    </table>

    <h4>Device State</h4>
    <p>The device state is a 4 bit number, representing the current state of the device.</p>
    <table>
        <tr>
            <th>Index</th>
            <th>State</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>0</td>
            <td>Unknown</td>
            <td>The current device state is unknown</td>
        </tr>
        <tr>
            <td>1</td>
            <td>Checking CRC</td>
            <td>The CRC calculation is currently running</td>
        </tr>
        <tr>
            <td>2</td>
            <td>CRC error</td>
            <td>The application CRC is invalid</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Application start</td>
            <td>The application is starting</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Application running</td>
            <td>The application is running</td>
        </tr>
        <tr>
            <td>5</td>
            <td>Application shutdown</td>
            <td>The application is shutting down</td>
        </tr>
        <tr>
            <td>6</td>
            <td>Application stopped</td>
            <td>The application is stopped</td>
        </tr>
        <tr>
            <td>7</td>
            <td>Reserved</td>
        </tr>
        
    </table>
</document-page>

<document-page>
    <h3>Command 0x01 - <span>Get Hardware Information</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Hardware Information / non-acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command will return the hardware information table.</p>

    
    <h4>Hardware  Information</h4>
    <table>
        <tr>
            <th>Index</th>
            <th>Data</th>
            <th>Size in Bytes</th>
            <th>Description</th>
        </tr>

        <tr>
            <td>0-1</td>
            <td>Controller Id</td>
            <td>2</td>
            <td>Controller Id. See Processor Id Table</td>
        </tr>
        <tr>
            <td>2-3</td>
            <td>Hardware Id</td>
            <td>2</td>
            <td></td>
        </tr>
        <tr>
            <td>4</td>
            <td>Major Hardware Revision</td>
            <td>1</td>
            <td></td>
        </tr>
        <tr>
            <td>5</td>
            <td>Minor Hardware Revision</td>
            <td>1</td>
            <td></td>
        </tr>
        <tr>
            <td>6</td>
            <td>Major Kernel Revision</td>
            <td>1</td>
            <td></td>
        </tr>
        <tr>
            <td>7</td>
            <td>Minor Kernel Revision</td>
            <td>1</td>
            <td></td>
        </tr>
    </table>

    <h3>Command 0x02 - <span>Get Memory Information</h3>
        <table class='protocol'>
            <tr class='protocol'>
                <th class='protocol'>Payload</th>
                <td class='protocol'>Empty</td>
            </tr>
            <tr class='protocol'>
                <th class='protocol'>Reply</th>
                <td class='protocol'>Memory Information / non-acknowledgment</td>
            </tr>
            <tr class='protocol'>
                <th class='protocol'>Error Handling</th>
                <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
            </tr>
        </table>
        <p>This command will return the memory information table.</p>
    
        <h4>Memory Information</h4>
        <table>
            <tr>
                <th>Index</th>
                <th>Data</th>
                <th>Size in Bytes</th>
                <th>Description</th>
            </tr>
            <tr>
                <td>0-1</td>
                <td>Flash size</td>
                <td>2</td>
                <td>Flash size in bytes</td>
            </tr>
            <tr>
                <td>2-3</td>
                <td>Application start</td>
                <td>2</td>
                <td>Flash application sector start address in bytes</td>
            </tr>
            <tr>
                <td>4</td>
                <td>Flash Page Size</td>
                <td>1</td>
                <td>Size of one flash page in bytes</td>
            </tr>
            <tr>
                <td>5-6</td>
                <td>RAM Size</td>
                <td>2</td>
                <td>Size of the RAM in bytes</td>
            </tr>
            <tr>
                <td>7-8</td>
                <td>RAM application start</td>
                <td>2</td>
                <td>RAM application sector start address</td>
            </tr>
            <tr>
                <td>9-10</td>
                <td>EEPROM Size</td>
                <td>2</td>
                <td>Size of the EEPROM in bytes</td>
            </tr>
            <tr>
                <td>11-12</td>
                <td>EEPROM application start</td>
                <td>2</td>
                <td>EEPROM application sector start address</td>
            </tr>
        </table>
</document-page>

<document-page>
    <h3>Command 0x03 - Get Application CRC</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>CRC of the application flash section / non-acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command will calculate the CRC of the application memory section and return it.</p>

    <h3>Command 0x04 - <span>Erase App Section</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command will erase the application sector of the target device. 
        If the application is running, it will be stopped. 
        After the erasing process is successfully completed, the target device will reply with an acknowledgment. 
        If the erasing process fails, the target will reply with a non-acknowledgment.</p>

    <h3>Command 0x05 - Write Page</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Page Address + Page Data</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>The application image is transferred in 16-Byte junks. Shorter frames must be padded with 255 (FFh).</p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
            <th>16</th>
            <th>17</th>
        </tr>
        <tr>
            <th>Data</th>
            <td colspan="2" >16 Bit Word Address</td>
            <td colspan="16" >Databyte 0 - 15</td>
        </tr>
    </table>
</document-page>

<document-page>
    <h3>Command 0x06 - Write EEPROM</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Address + Data</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>The EEPROM data can be transferred in 1 - 16 byte junks. Unused bytes shall not be transmitted.</p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
            <th>16</th>
            <th>17</th>
        </tr>
        <tr>
            <th>Data</th>
            <td colspan="2" >16 Bit Byte Address</td>
            <td colspan="16" >Databyte 0 - 15</td>
        </tr>
    </table>

    <h3>Command 0x07 - Read EEPROM</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Address + Size</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>EEPROM Data</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>The EEPROM data can be requested in 1-16 byte junks. Unused bytes shall not be transmitted.</p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>

        </tr>
        <tr>
            <th>Data</th>
            <td colspan="2">16 Bit Address</td>
            <td colspan="1">Size</td>
        </tr>
    </table>
    <p><b>Reply</b></p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
        </tr>
        <tr>
            <th>Data</th>
            <td colspan="16" >Databyte 0 - 15</td>
        </tr>
    </table>

    <h3>Command 0x08 - Read RAM</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Address + Size</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>RAM Data</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>The RAM data can be requested in 1-16-Byte junks. Unused bytes shall not be transmitted.</p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>

        </tr>
        <tr>
            <th>Data</th>
            <td colspan="2">16 Bit Address</td>
            <td colspan="1">Size</td>
        </tr>
    </table>
    <p><b>Reply</b></p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>  
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
        </tr>
        <tr>
            <th>Data</th>
            <td colspan="16" >Databyte 0 - 15</td>
        </tr>
    </table>
</document-page>

<document-page>
    <h3>Command 0x0A - Reboot</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>None</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command will restart the device. This should be accomplished via a hardware reset of the device.
       If a hardware-reset can not be triggered via software, it is sufficient to jump to the boot vector of the device.</p>
    
    <p><strong>Note:</strong> The application will not be shutdown! Peripherals may stay initialized.</p>

    <h3>Command 0x0B - Start App</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command will verify the CRC of the application and, in case of a valid CRC, start the application.</p>

    <h3>Command 0x0C - Stop App</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command will shutdown the application.</p>
</document-page>

<document-page>
    <h3>Command 0x0D - Get Application Name</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Application Name</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>In case of a valid CRC, this command will return the application name. Otherwise, a non-acknowledgment is returned.</p>
    <p>The application name lenght can be between 1-18 bytes. Unused bytes are not transmitted.</p>
    <p><b>Reply</b></p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
            <th>16</th>
            <th>17</th>
        </tr>
        <tr>
            <th>Data</th>
            <td colspan="18" >Application Name</td>
        </tr>
    </table>

    <h3>Command 0x0E - Get Application Version</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Application Version</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>In case of a valid CRC, this command will return the application version. Otherwise, a non-acknowledgment is returned.</p>

    <p><b>Reply</b></p>
    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
            <th>1</th>
        </tr>
        <tr>
            <th>Data</th>
            <td>Major Firmware Revision</td>
            <td>Minor Firmware Revision</td>
        </tr>
    </table>

    <h3>Command 0x0F - Set Address</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>New Address</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    
    <p>This command changes the current device address to a new address. </p>
    <p>Valid addresses are 1-14 (01h - 0Eh)</p>
    <p><strong>Note: </strong>The address change will become effective after a device reboot.</p>

</document-page>

<document-page>
    <h3>Command 0x20 - Set Baud Rate</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>New baud rate index</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>None</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
    <p>This command changes the current baud rate to the new baud rate.</p>
    <p><strong>Note:</strong> The baud rate change is not saved to non-volatile memory.</p>
    <p>To save the baud rate change use the "Save Baud Rate" command.</p>

    <table>
        <tr>
            <th class='command_header'>Byte</th>
            <th>0</th>
        </tr>
        <tr>
            <th>Data</th>
            <td>Baud Rate Index</td>
        </tr>
    </table>

    <p></p>
    <table style="border: none;">
        <tr>
            <th class='command_header'>Index</th>
            <th>Baud Rate</th>
            <td style="border: none;"></td>
            <th class='command_header'>Index</th>
            <th>Baud Rate</th>
        </tr>
        <tr>
            <td>0</td>
            <td>300</td>
            <td style="border: none;"></td>
            <td>4</td>
            <td>4800</td>
        </tr>
        <tr>
            <td>1</td>
            <td>600</td>
            <td style="border: none;"></td>
            <td>5</td>
            <td>9600</td>
        </tr>
        <tr>
            <td>2</td>
            <td>1200</td>
            <td style="border: none;"></td>
            <td>6</td>
            <td>14400</td>
        </tr>
        <tr>
            <td>3</td>
            <td>2400</td>
            <td style="border: none;"></td>
            <td>7</td>
            <td>19200</td>
        </tr>
    </table>



    <h3>Command 0x21 - Save Baud Rate</h3>
    <table class='protocol'>
        <tr class='protocol'>
            <th class='protocol'>Payload</th>
            <td class='protocol'>Empty</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Reply</th>
            <td class='protocol'>Acknowledgment</td>
        </tr>
        <tr class='protocol'>
            <th class='protocol'>Error Handling</th>
            <td class='protocol'>If the command exicution fails, a non-acknowledgment will be replied.</td>
        </tr>
    </table>
   <p>This command will save the current baud rate to non-volatile memory.</p>
</document-page>

<document-page>
    <h2>Appendix</h2>
    <h3>Why the automatic baud rate detection was removed</h3>
    <p>The automatic baud detection needs hardware support in some form. This reduces the selection of hardware.</p>
    <p>Most UART hardware only has support for LIN-Style baud rate detection, using a 'break' before synchronization. TinyBus was designed to be compatible with standard UART/RS-232 interfaces and therefore does not rely on the ability to send breaks.</p>
    <p>Automatic baud detection can be implemented by using only a timer but smaller microcontrollers only have a few timers. Dedicating a timer to automatic baud detection seems too restrictive on the application.</p>
    
    <h4>Removed section</h4>
    <p><b>Automatic Baud Rate Detection</b></p>
    <p>The bus baud rate is automatically detected based on the COBS delimiter byte (55h / 01010101b).</p>
    <p>The supported baud rates shall not be limited to standard baud rates.</p>
    <p>The baud rate detection may be done only once at device startup and does not need to be repeted for each frame.</p>
</document-page>



</div>
</body>